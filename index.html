<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Valentine’s Side Quest</title>
<style>
  body {
    margin: 0;
    background: black;
    color: #ff9ecb;
    font-family: monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  #container {
    width: 900px;
    max-width: 95vw;
    text-align: center;
  }

  canvas {
    display: none;
    background: #0b0b0b;
    border: 2px solid #ff9ecb;
    margin: 0 auto;
  }

  button {
    background: black;
    color: #ff9ecb;
    border: 2px solid #ff9ecb;
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
  }

  button:hover {
    background: #ff9ecb;
    color: black;
  }

  #dialogue {
    min-height: 140px;
    white-space: pre-wrap;
  }

  .hidden { display: none; }
</style>
</head>
<body>
<div id="container">
  <div id="dialogue"></div>
  <button id="actionBtn" class="hidden">Begin Side Quest</button>
  <canvas id="game" width="900" height="300"></canvas>
</div>

<script>
/* ===== TYPEWRITER ===== */
const dialogueBox = document.getElementById("dialogue");
const actionBtn = document.getElementById("actionBtn");
function typeText(text, callback){
  dialogueBox.innerHTML="";
  let i=0;
  const interval=setInterval(()=>{
    dialogueBox.innerHTML+=text[i];
    i++;
    if(i>=text.length){
      clearInterval(interval);
      if(callback) callback();
    }
  },30);
}

/* ===== GAME SETUP ===== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let keys={};
let level=1;
let gameRunning=false;
const gravity=0.6;
const groundHeight=260;

/* ===== PLAYER (PIXEL PUPPY) ===== */
const player={x:100,y:0,vx:0,vy:0,width:18,height:14,onGround:false,barkTimer:0};

/* ===== CAMERA ===== */
let cameraX=0;

/* ===== LEVEL DATA ===== */
const levels={
  1:{length:2400,platforms:[],bones:Array.from({length:5},(_,i)=>({x:400+i*300,y:220,collected:false}))},
  2:{length:2800,platforms:[
      {x:600,y:200,w:80},{x:820,y:170,w:80},{x:1100,y:190,w:80},{x:1500,y:160,w:100}
    ],bones:Array.from({length:6},(_,i)=>({x:500+i*350,y:150,collected:false}))},
  3:{length:3000,platforms:[
      {x:700,y:180,w:90},{x:1000,y:150,w:90},{x:1400,y:190,w:90},{x:1800,y:140,w:120}
    ],
    gaps:[{x:900,w:120},{x:1300,w:160},{x:1700,w:180}],
    bones:Array.from({length:7},(_,i)=>({x:600+i*300,y:200,collected:false})),
    heart:{x:2600,y:200,size:40}
  }
};

/* ===== INPUT ===== */
window.addEventListener("keydown", e=>keys[e.key]=true);
window.addEventListener("keyup", e=>keys[e.key]=false);

/* ===== PUPPY DRAW ===== */
function drawPuppy(px,py){
  ctx.save();
  ctx.fillStyle="#a0522d"; // brown body
  // Body
  ctx.fillRect(px,py+6,18,8);
  // Head
  ctx.fillRect(px+12,py,6,6);
  // Ears
  ctx.fillRect(px+11,py-3,3,3);
  ctx.fillRect(px+14,py-3,3,3);
  // Tail
  let tailOffset=Math.sin(Date.now()/100)*3;
  ctx.fillRect(px-4,py+10+tailOffset,4,2);
  // Eyes
  ctx.fillStyle="black";
  ctx.fillRect(px+13,py+1,1,1);
  ctx.fillRect(px+16,py+1,1,1);
  // Nose
  ctx.fillRect(px+15,py+3,2,2);
  // Tongue pops out when jumping
  if(!player.onGround){
    ctx.fillStyle="#ff69b4";
    ctx.fillRect(px+14,py+6,2,2);
  }
  // Bark animation
  if(player.barkTimer>0){
    ctx.fillStyle="#ff69b4";
    ctx.font="12px monospace";
    ctx.fillText("woof! ♥",px,py-6);
    player.barkTimer--;
  }
  ctx.restore();
}

/* ===== PARTICLES ===== */
let pawParticles=[];
function spawnPaw(x,y){
  pawParticles.push({x:x,y:y,alpha:1});
}
function drawPaws(){
  pawParticles.forEach((p,i)=>{
    ctx.fillStyle=`rgba(255,158,203,${p.alpha})`;
    ctx.fillRect(p.x,p.y,3,2);
    p.alpha-=0.02;
    if(p.alpha<=0) pawParticles.splice(i,1);
  });
}

/* ===== GAME LOOP ===== */
function update(){
  if(!gameRunning) return;
  // movement
  if(keys["ArrowRight"]){player.vx=3; spawnPaw(player.x,player.y+player.height);}
  else if(keys["ArrowLeft"]){player.vx=-3; spawnPaw(player.x,player.y+player.height);}
  else player.vx*=0.8;
  if(keys[" "] && player.onGround){player.vy=-10;player.onGround=false;player.barkTimer=20;}
  player.vy+=gravity;
  player.x+=player.vx;
  player.y+=player.vy;

  // ground collision
  player.onGround=false;
  if(player.y+player.height>=groundHeight){player.y=groundHeight-player.height;player.vy=0;player.onGround=true;}

  // platforms
  levels[level].platforms?.forEach(p=>{
    if(player.x+player.width>p.x && player.x<p.x+p.w &&
       player.y+player.height>p.y && player.y+player.height<p.y+10 && player.vy>=0){
      player.y=p.y-player.height;player.vy=0;player.onGround=true;
    }
  });

  // gaps (level 3)
  levels[level].gaps?.forEach(g=>{
    if(player.x>g.x && player.x<g.x+g.w && player.y>canvas.height){player.x=100;player.y=0;cameraX=0;}
  });

  cameraX=player.x-canvas.width/2;

  draw();
  requestAnimationFrame(update);
}

/* ===== DRAW WORLD ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-cameraX,0);
  // background
  ctx.fillStyle="#0b0b0b";
  ctx.fillRect(cameraX,0,canvas.width,canvas.height);
  // ground
  ctx.fillStyle="#ff9ecb";
  ctx.fillRect(0,groundHeight,levels[level].length,40);
  // platforms
  ctx.fillStyle="#d891b3";
  levels[level].platforms?.forEach(p=>ctx.fillRect(p.x,p.y,p.w,10));
  // bones
  levels[level].bones?.forEach(b=>{
    if(!b.collected){
      ctx.fillStyle="#ffc0cb";
      ctx.fillRect(b.x,b.y,10,6);
      if(player.x<b.x+10 && player.x+player.width>b.x && player.y<b.y+6 && player.y+player.height>b.y){
        b.collected=true;
        if(levels[level].bones.every(x=>x.collected)) finishLevel();
      }
    }
  });
  // heart (level3)
  if(level===3){
    const h=levels[3].heart;
    ctx.fillStyle="#ff69b4";
    ctx.fillRect(h.x,h.y,h.size,h.size);
    if(player.x<h.x+h.size && player.x+player.width>h.x && player.y<h.y+h.size && player.y+player.height>h.y) endGame();
  }
  drawPuppy(player.x,player.y);
  drawPaws();
  ctx.restore();
}

/* ===== LEVEL TRANSITIONS ===== */
function finishLevel(){
  gameRunning=false;
  canvas.style.display="none";
  if(level===1){
    typeText("BOSS FIGHT UNLOCKED.\nStrength isn’t loud. It’s disciplined.\n\nProceed?",()=>{
      actionBtn.textContent="Next Level";
      actionBtn.classList.remove("hidden");
      actionBtn.onclick=()=>startLevel(2);
    });
  }else if(level===2){
    typeText("SYSTEM BREACH.\nYou adapt. You persist.\n\nContinue deeper?",()=>{
      actionBtn.textContent="Final Level";
      actionBtn.classList.remove("hidden");
      actionBtn.onclick=()=>startLevel(3);
    });
  }
}

function startLevel(n){
  level=n;
  player.x=100;
  player.y=0;
  cameraX=0;
  actionBtn.classList.add("hidden");
  dialogueBox.innerHTML="";
  canvas.style.display="block";
  gameRunning=true;
  update();
}

function endGame(){
  gameRunning=false;
  canvas.style.display="none";
  typeText(
    "ENDGAME.\n\nThat moment — quiet, safe, present.\nWhere the world fell away.\n\nYou don’t make me feel strange.\nYou make me feel here.\n\nWell done, Mr. Cody.",
    ()=>{}
  );
}

/* ===== INTRO ===== */
typeText("SYSTEM ONLINE.\n\nPress Y to begin.",()=>{
  window.addEventListener("keydown",e=>{
    if(e.key.toLowerCase()==="y"){
      actionBtn.classList.remove("hidden");
    }
  });
});

actionBtn.onclick=()=>{
  actionBtn.classList.add("hidden");
  dialogueBox.innerHTML="";
  canvas.style.display="block";
  gameRunning=true;
  update();
};
</script>
</body>
</html>
