<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Valentine's Side Quest</title>
<style>
  body {
    margin: 0;
    background: black;
    color: #ff66aa;
    font-family: monospace;
    overflow: hidden;
  }
  #terminal {
    padding: 20px;
    white-space: pre-wrap;
    font-size: 18px;
  }
  #gameCanvas {
    display: none;
    background: black;
    margin: auto;
    display: block;
  }
  #dialogueBox {
    display: none;
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #111;
    border: 2px solid #ff66aa;
    padding: 20px;
    color: #ff66aa;
    font-family: monospace;
    max-width: 600px;
  }
  .clickable {
    cursor: pointer;
    text-decoration: underline;
  }
</style>
</head>
<body>

<div id="terminal"></div>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<div id="dialogueBox"></div>

<script>
// ELEMENTS
const terminal = document.getElementById("terminal");
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const dialogueBox = document.getElementById("dialogueBox");

// GAME STATE
let gameStarted = false;
let currentLevel = 0;
let mazeSize = 10;
let player = {x:1, y:1};
let maze = [];
let collected = 0;
let totalCollectibles = 0;

// LEVEL DATA (simple tile maps)
// 0 = empty, 1 = wall, 2 = collectible
const levels = [
  [
    [1,1,1,1,1,1,1,1,1,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,0,1,1,0,1,1,0,2,1],
    [1,0,0,0,2,0,0,0,0,1],
    [1,1,1,0,1,0,1,1,0,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,0,1,1,0,1,1,0,2,1],
    [1,0,0,0,2,0,0,0,0,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,1,1,1,1,1,1,1,1,1],
  ],
  [
    [1,1,1,1,1,1,1,1,1,1],
    [1,2,0,1,0,0,1,2,0,1],
    [1,0,1,1,0,1,1,0,2,1],
    [1,0,0,0,2,0,0,0,0,1],
    [1,1,1,0,1,0,1,1,0,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,0,1,1,0,1,1,0,2,1],
    [1,0,0,0,2,0,0,0,0,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,1,1,1,1,1,1,1,1,1],
  ],
  [
    [1,1,1,1,1,1,1,1,1,1],
    [1,2,0,1,0,0,1,2,0,1],
    [1,0,1,1,0,1,1,0,2,1],
    [1,0,0,0,2,0,0,0,0,1],
    [1,1,1,0,1,0,1,1,0,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,0,1,1,0,1,1,0,2,1],
    [1,0,0,0,2,0,0,0,0,1],
    [1,2,0,0,0,0,0,2,0,1],
    [1,1,1,1,1,1,1,1,1,1],
  ]
];

// TERMINAL INTRO
const introLines = [
  "YOU'VE BEEN HACKED BY BUNNY! MUHAHAHA",
  "!!! SYSTEM COMPROMISED !!!",
  "!!! UNAUTHORIZED ACCESS DETECTED !!!",
  "Press Y to continue… if you dare"
];

let lineIndex = 0;
let charIndex = 0;

function typeLine() {
  if(lineIndex < introLines.length){
    if(charIndex < introLines[lineIndex].length){
      terminal.textContent += introLines[lineIndex][charIndex];
      charIndex++;
      setTimeout(typeLine, 50);
    } else {
      terminal.textContent += "\n";
      lineIndex++;
      charIndex = 0;
      setTimeout(typeLine, 300);
    }
  }
}
typeLine();

function flickerTerminal() {
  if(Math.random() < 0.1){
    terminal.style.color = "#ff99cc";
  } else {
    terminal.style.color = "#ff66aa";
  }
  if(!gameStarted) setTimeout(flickerTerminal, 100);
}
flickerTerminal();

// KEY PRESS TO START
document.addEventListener("keydown", function(e){
  if(!gameStarted && (e.key === "y" || e.key === "Y")){
    startLevel(currentLevel);
  } else {
    movePlayer(e.key);
  }
});

// START LEVEL
function startLevel(levelNum){
  gameStarted = true;
  terminal.style.display = "none";
  canvas.style.display = "block";
  maze = JSON.parse(JSON.stringify(levels[levelNum]));
  player = {x:1, y:1};
  collected = 0;
  totalCollectibles = maze.flat().filter(t=>t===2).length;
  drawMaze();
}

// DRAW MAZE
function drawMaze(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const tileSize = canvas.width / mazeSize;
  for(let y=0;y<mazeSize;y++){
    for(let x=0;x<mazeSize;x++){
      if(maze[y][x]===1){
        ctx.fillStyle = "#ff66aa";
        ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
      } else if(maze[y][x]===2){
        ctx.fillStyle = "pink";
        ctx.fillRect(x*tileSize+tileSize/4, y*tileSize+tileSize/4, tileSize/2, tileSize/2);
      }
    }
  }
  // Draw player
  ctx.fillStyle = "brown";
  ctx.fillRect(player.x*tileSize, player.y*tileSize, tileSize, tileSize);
}

// MOVE PLAYER
function movePlayer(key){
  if(!gameStarted) return;
  let newX = player.x;
  let newY = player.y;
  if(key==="ArrowUp") newY--;
  if(key==="ArrowDown") newY++;
  if(key==="ArrowLeft") newX--;
  if(key==="ArrowRight") newX++;
  if(maze[newY][newX]!==1){
    player.x = newX;
    player.y = newY;
    if(maze[newY][newX]===2){
      maze[newY][newX]=0;
      collected++;
      if(collected===totalCollectibles){
        showDialogueForLevel();
      }
    }
    drawMaze();
  }
}

// DIALOGUE PLACEHOLDER
function showDialogueForLevel(){
  canvas.style.display = "none";
  dialogueBox.style.display = "block";
  dialogueBox.innerHTML = `Level ${currentLevel+1} Complete!<br><span class="clickable" id="nextLevel">Click to continue</span>`;
  document.getElementById("nextLevel").addEventListener("click", function(){
    dialogueBox.style.display = "none";
    currentLevel++;
    if(currentLevel<levels.length){
      startLevel(currentLevel);
    } else {
      showEndgame();
    }
  });
}

// ENDGAME
function showEndgame(){
  canvas.style.display = "block";
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Draw pixel heart
  ctx.fillStyle = "green";
  ctx.fillRect(370,180,20,20);
  ctx.fillRect(390,180,20,20);
  ctx.fillRect(360,200,20,20);
  ctx.fillRect(400,200,20,20);
  ctx.fillRect(370,220,40,20);

  dialogueBox.style.display = "block";
  dialogueBox.innerHTML = 'Well done, Mr. Cody! <span class="clickable" id="heartClick">Click the heart</span>';
  document.getElementById("heartClick").addEventListener("click", showBonus);
}

// BONUS LOOT
function showBonus(){
  dialogueBox.style.display = "none";
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Draw cassette
  ctx.fillStyle = "black";
  ctx.fillRect(360,180,80,40); // body
  ctx.fillStyle = "white";
  ctx.fillRect(365,185,70,30); // label
  ctx.fillStyle = "green";
  ctx.fillRect(365,200,30,10); // tape reel left
  ctx.fillRect(405,200,30,10); // tape reel right
  // Heart on cassette
  ctx.fillStyle = "black";
  ctx.fillRect(395,190,10,10);
  ctx.fillStyle = "white";
  ctx.fillRect(396,191,8,8);

  dialogueBox.style.display = "block";
  dialogueBox.innerHTML = 'Bonus Loot Unlocked: Puppy’s Playlist! <span class="clickable" id="cassetteClick">Click to listen</span>';
  document.getElementById("cassetteClick").addEventListener("click", function(){
    alert("Link to playlist here!");
  });
}
</script>

</body>
</html>
